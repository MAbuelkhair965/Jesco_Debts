<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JESKO ERP - السجل السحابي</title>
    <style>
        :root { --primary: #007bff; --dark: #1a1a1a; --card: #2d2d2d; --text: #ffffff; --accent: #ff4500; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--dark); color: var(--text); padding: 20px; }
        .container { max-width: 900px; margin: auto; }
        .header { background: var(--card); padding: 20px; border-radius: 8px; border-bottom: 4px solid var(--primary); margin-bottom: 20px; }
        .input-group { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        input { padding: 12px; border-radius: 4px; border: 1px solid #444; background: #3d3d3d; color: white; flex: 1; min-width: 150px; }
        button { cursor: pointer; background: var(--primary); color: white; border: none; padding: 12px 20px; border-radius: 4px; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; background: var(--card); border-radius: 8px; overflow: hidden; margin-top: 10px; }
        th, td { padding: 15px; text-align: right; border-bottom: 1px solid #444; }
        th { background: #333; color: var(--primary); }
        .history-list { font-size: 0.85rem; color: #bbb; padding: 0; list-style: none; margin: 0; }
        .history-list li { background: #383838; margin-bottom: 4px; padding: 5px; border-radius: 3px; border-right: 3px solid var(--primary); }
        .total-box { margin-top: 20px; background: var(--card); padding: 20px; border-radius: 8px; font-size: 1.5rem; border-right: 5px solid var(--accent); }
        .delete-btn { background: #dc3545; margin-right: 5px; padding: 8px; font-size: 0.8rem; }
    </style>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
</head>
<body>

<div class="container">
    <div class="header"><h1>JESKO ERP - نظام الديون السحابي</h1></div>
    
    <div class="input-group">
        <input type="text" id="nameInput" placeholder="اسم الشخص (مثلاً: عميل ستاندات)">
        <input type="number" id="amountInput" placeholder="المبلغ الكلي">
        <button onclick="addDebt()">إضافة للسحابة</button>
    </div>

    <table>
        <thead>
            <tr>
                <th>الاسم</th>
                <th>المبلغ المتبقي</th>
                <th>سجل الدفعات</th>
                <th>إجراء</th>
            </tr>
        </thead>
        <tbody id="debtBody"></tbody>
    </table>

    <div class="total-box">إجمالي الديون المعلقة: <span id="grandTotal">0</span> ج.م</div>
</div>

<script>
    // بيانات الربط الخاصة بمشروعك (من صورتك)
    const firebaseConfig = {
        apiKey: "AIzaSyADCXCtLlwART44oEK7B36PmCfzE8mTxi0",
        authDomain: "jesko-erp.firebaseapp.com",
        projectId: "jesko-erp",
        storageBucket: "jesko-erp.firebasestorage.app",
        messagingSenderId: "820083064794",
        appId: "1:820083064794:web:2a7f80e53b6ecb94660ae3",
        measurementId: "G-JKXB3PPXGD"
    };

    // بدء تشغيل Firebase
firebase.initializeApp(firebaseConfig);

// تفعيل قاعدة البيانات (تأكد من وجود السطر ده)
const db = firebase.firestore(); 

// السطر ده مهم جداً عشان يحل مشكلة الـ Permission في بعض المتصفحات
db.settings({ experimentalForceLongPolling: true });

    // إضافة شخص جديد لقاعدة البيانات
    function addDebt() {
        const name = document.getElementById('nameInput').value;
        const amount = parseFloat(document.getElementById('amountInput').value);
        if (name && amount > 0) {
            db.collection("debts").add({
                name: name,
                remaining: amount,
                original: amount,
                payments: [],
                date: new Date()
            });
            document.getElementById('nameInput').value = '';
            document.getElementById('amountInput').value = '';
        }
    }

    // تسجيل دفعة جديدة وتحديثها في السحابة
    function payAmount(id, currentRemaining) {
        const pay = parseFloat(prompt("أدخل المبلغ المدفوع حالياً:"));
        if (pay && pay <= currentRemaining) {
            const dateStr = new Date().toLocaleString('ar-EG', { dateStyle: 'short', timeStyle: 'short' });
            db.collection("debts").doc(id).update({
                remaining: currentRemaining - pay,
                payments: firebase.firestore.FieldValue.arrayUnion({ amount: pay, date: dateStr })
            });
        } else if (pay > currentRemaining) {
            alert("المبلغ أكبر من المتبقي!");
        }
    }

    // مسح السجل نهائياً
    function deleteDebt(id) {
        if (confirm("هل أنت متأكد من مسح هذا الشخص نهائياً؟")) {
            db.collection("debts").doc(id).delete();
        }
    }

    // تحديث الجدول لحظياً عند حدوث أي تغيير في جوجل
    db.collection("debts").orderBy("date", "desc").onSnapshot((snapshot) => {
        const tbody = document.getElementById('debtBody');
        tbody.innerHTML = '';
        let total = 0;

        snapshot.forEach((doc) => {
            const debt = doc.data();
            const id = doc.id;
            total += debt.remaining;
            let paymentsHTML = debt.payments.map(p => `<li>✔ تم دفع ${p.amount} في ${p.date}</li>`).join('');

            tbody.innerHTML += `
                <tr>
                    <td><strong>${debt.name}</strong></td>
                    <td style="color: #ffc107; font-weight: bold;">${debt.remaining.toLocaleString()} ج.م</td>
                    <td><ul class="history-list">${paymentsHTML || 'لا يوجد دفعات'}</ul></td>
                    <td>
                        <button onclick="payAmount('${id}', ${debt.remaining})">سداد</button>
                        <button class="delete-btn" onclick="deleteDebt('${id}')">حذف</button>
                    </td>
                </tr>`;
        });
        document.getElementById('grandTotal').innerText = total.toLocaleString();
    });
</script>
</body>
</html>

